\documentclass[11pt,a4paper]{article}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}

\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{booktabs}

\usepackage{cite}


\newtheorem{theorem}{Theorem}

\usepackage{listings}
\usepackage{color} %red, green, blue, yellow, cyan, magenta, black, white
\definecolor{mygreen}{RGB}{28,172,0} % color values Red, Green, Blue
\definecolor{mylilas}{RGB}{170,55,241}


\usepackage{graphicx}
\begin{document}
\section{Intro}
Want to discertize the problem:
\begin{align}
\left\{
     \begin{array}{lr}
       	y'(t)=\alpha y(t) +u(t), \ t \in (0,T)\\
       	   y(0)=y_0
     \end{array}
   \right. \label{equation}
\end{align}
\begin{align}
J(y,u) = \frac{1}{2}\int_0^Tu(t)^2dt + \frac{1}{2}(y(T)-y^T)^2
\label{problem}
\end{align}
We know that the the reduced gradient of (\ref{problem}) is:
\begin{align}
\nabla\hat{J}(u) = u(t)+p(t) \label{gradiant}
\end{align}
where $p$ is the solution of the adjoint equation:
\begin{align}   
  \left\{
     \begin{array}{lr}
	-p'(t) = \alpha p(t) \\
	p(T) = y(T)-y^T     \
	\end{array}
   \right. \label{adjoint}
\end{align}
We now want to discretize (\ref{equation}-\ref{adjoint}), so we can solve the problem numerically. What we particularry eant, is an expression for the gradient. 
\section{Finite difference}
Before I state what the numerical gradient will be for the implicit end explicit Euler schemes, I will write up these schemes for our equations (\ref{equation}) and (\ref{adjoint}). First the implicit for the state equation:
\begin{align}
\frac{y^n-y^{n-1}}{\Delta t} &= \alpha y^{n} + u^{n} \\
(1-\alpha\Delta t)y^{n} &= y^{n-1} +\Delta t u^{n} \\
y^n &=\frac{y^{n-1} +\Delta t u^{n}}{1-\alpha\Delta t} \label{I_state}
\end{align}
Implicit Euler for the adjoint equation:
\begin{align}
-\frac{p^n-p^{n-1}}{\Delta t} -\alpha p^{n-1} &=0 \\
(1-\Delta t\alpha)p^{n-1}&=p^n \\
p^{n-1} &= \frac{p^n}{1-\Delta t\alpha} \label{I_adjoint}
\end{align}
The explicit scheme for the state equation reads:
\begin{align}
\frac{y^{n+1}-y^{n}}{\Delta t} &= \alpha y^{n} + u^{n} \\
y^{n+1}&=(1 +\Delta t\alpha) y^{n} + \Delta t u^{n}\label{E_state}
\end{align} 
and the for the adjoint we have:
\begin{align}
-\frac{p^n-p^{n-1}}{\Delta t} -\alpha p^{n} &=0 \\
p^{n-1} &=p^n(1 +\Delta t\alpha)\label{E_adjoint}
\end{align}
With these formulas in mind lets 
\section{Numerical gradient}
\begin{theorem}
Discrtizing the adjoint and state equation using the implicit Euler finite difference scheme, and evaluating the integral in the functional using the trapezoid rule, means that the numerical gradient will look like the following:
\begin{align*}
\nabla J_{\Delta t}(u_{\Delta t}) = Mu_{\Delta t} + Bp_{\Delta t}
\end{align*}
where $M$ and $B$ are the following matrices:
\begin{align*}
M=\left[ \begin{array}{cccc}
   \frac{1}{2}\Delta t & 0 & \cdots & 0 \\  
   0& \Delta t & 0 & \cdots \\ 
   0 &0 & \Delta t  & \cdots \\
   0 &\cdots &0 & \frac{1}{2}\Delta t   \\
   \end{array}  \right] 
,B = \left[ \begin{array}{cccc}
   0& 0 & \cdots & 0 \\  
   \Delta t& 0 & 0 & \cdots \\ 
   0 & \Delta t& 0  & \cdots \\
   0 &\cdots & \Delta t& 0   \\
   \end{array}  \right] 
\end{align*}
If one instead uses the explicit Euler finite difference scheme on the differential equations, the gradient will instead look like:
\begin{align*}
\nabla J_{\Delta t}(u_{\Delta t}) = Mu_{\Delta t} + B^*p_{\Delta t}
\end{align*}
\end{theorem}
\begin{proof}
Let us start with the $Mu$ term of the gradient. This term comes from the integral $\int_0^T u(t)^2dt$, which we evaluate using the trapezoid rule, which looks as the following:
\begin{align*}
\int_0^T u(t)^2dt \approx \Delta t\frac{u_0^2+u_N^2}{2} + \sum_{i=1}^{N-1} \Delta t u_i^2 = u^*Mu
\end{align*} 
The function $f(u)=u^*Mu$ obviously have $Mu$ as gradient. The second term of the gradient comes from the second term of the functional, namely $g(u)=\frac{1}{2}(y_N -y^T)^2$. To differentiate $g$ with respect to the i'th component of $u$, we will apply the chain rule multiple times. Lets first demonstrate by calculating $\frac{\partial g}{\partial u_N}$, in a setting where we have used explicit euler to solve the equations:
\begin{align*}
\frac{\partial g(u)}{\partial u_N} &= \frac{\partial g(u)}{\partial y_N}\frac{\partial y_N}{\partial u_N} = (y_N -y^T)\frac{\partial y_N}{\partial u_N}\\
&= (y_N -y^T)\frac{\Delta t}{1-\alpha\Delta t}
\end{align*}
To get to the second line I used the implicit Euler formula (\ref{I_state}). If we then look at the scheme (\ref{I_adjoint}) for the adjoint equation, we see that:
\begin{align*}
(y_N -y^T)\frac{\Delta t}{1-\alpha\Delta t} = \Delta t\frac{p_N}{1-\alpha\Delta t} = \Delta t p_{N-1}
\end{align*} 
Using the same approach, we can find an expression for $\frac{\partial g(u)}{\partial u_i}$: 
\begin{align*}
\frac{\partial g(u)}{\partial u_i}
\end{align*}
\end{proof}
\end{document}